{"version":3,"sources":["../../../lib/db.ts","../../../models/VerificationCode.ts"],"sourcesContent":["import mongoose from 'mongoose';\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI;\r\n\r\nif (!MONGODB_URI) {\r\n  throw new Error('Please define the MONGODB_URI environment variable inside .env.local');\r\n}\r\n\r\n/**\r\n * Global is used here to maintain a cached connection across hot reloads\r\n * in development. This prevents connections growing exponentially\r\n * during API Route usage.\r\n */\r\nlet cached = (globalThis as any).mongoose;\r\n\r\nif (!cached) {\r\n  cached = (globalThis as any).mongoose = { conn: null, promise: null };\r\n}\r\n\r\nasync function dbConnect() {\r\n  if (cached.conn) {\r\n    return cached.conn;\r\n  }\r\n\r\n  if (!cached.promise) {\r\n    const opts = {\r\n      bufferCommands: false,\r\n    };\r\n\r\n    cached.promise = mongoose.connect(MONGODB_URI!, opts).then((mongoose) => {\r\n      return mongoose;\r\n    });\r\n  }\r\n\r\n  try {\r\n    cached.conn = await cached.promise;\r\n  } catch (e) {\r\n    cached.promise = null;\r\n    throw e;\r\n  }\r\n\r\n  return cached.conn;\r\n}\r\n\r\nexport default dbConnect;","import mongoose, { Schema, model, models } from 'mongoose';\r\n\r\nconst VerificationCodeSchema = new Schema({\r\n  email: { type: String, required: true },\r\n  code: { type: String, required: true },\r\n  type: { type: String, required: true, enum: ['register', 'reset_password'] },\r\n  attempts: { type: Number, default: 0 },\r\n  used: { type: Boolean, default: false },\r\n  createdAt: { type: Date, default: Date.now, expires: 600 } // TTL index: 10 minutes (600 seconds)\r\n});\r\n\r\n// Compound unique index: ensure only one active code per email+type\r\nVerificationCodeSchema.index({ email: 1, type: 1 }, { unique: true });\r\n\r\nconst VerificationCode = models.VerificationCode || model('VerificationCode', VerificationCodeSchema);\r\n\r\nexport default VerificationCode;\r\n"],"names":[],"mappings":"k6DAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAc,QAAQ,GAAG,CAAC,WAAW,CAE3C,GAAI,CAAC,EACH,MAAM,AAAI,KADM,CACA,wEAQlB,IAAI,EAAU,WAAmB,QAAQ,CAMzC,eAAe,IACb,GAAI,EAAO,IAAI,CACb,CADe,MACR,EAAO,IAAI,CAGf,EAAO,OAAO,EAAE,AAKnB,GAAO,OAAO,CAAG,EAAA,OAAQ,CAAC,OAAO,CAAC,EAJrB,CACX,UAG8C,MAH9B,CAClB,GAEsD,IAAI,CAAC,AAAC,GACnD,EACT,EAGF,GAAI,CACF,EAAO,IAAI,CAAG,MAAM,EAAO,OAAO,AACpC,CAAE,MAAO,EAAG,CAEV,MADA,EAAO,OAAO,CAAG,KACX,CACR,CAEA,OAAO,EAAO,IAAI,AACpB,CA3BI,AAAC,IACH,EAAU,EADC,SACkB,QAAQ,CAAG,CAAE,KAAM,KAAM,QAAS,IAAK,oBA4BvD,4BC5Cf,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAyB,IAAI,EAAA,MAAM,CAAC,CACxC,MAAO,CAAE,KAAM,OAAQ,UAAU,CAAK,EACtC,KAAM,CAAE,KAAM,OAAQ,UAAU,CAAK,EACrC,KAAM,CAAE,KAAM,OAAQ,UAAU,EAAM,KAAM,CAAC,WAAY,iBAAiB,AAAC,EAC3E,SAAU,CAAE,KAAM,OAAQ,QAAS,CAAE,EACrC,KAAM,CAAE,KAAM,QAAS,QAAS,EAAM,EACtC,UAAW,CAAE,KAAM,KAAM,QAAS,KAAK,GAAG,CAAE,QAAS,GAAI,CAC3D,CAD6D,EAI7D,EAAuB,KAAK,CAAC,CAAE,MAAO,EAAG,KAAM,CAAE,EAAG,CAAE,QAAQ,CAAK,CAJgC,EAMnG,IAAM,EAAmB,EAAA,MAAM,CAAC,gBAAgB,EAAI,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,mBAAoB,oBAE/D"}